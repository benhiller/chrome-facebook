<html>
<head>
    <script src="jquery.js"></script>
<script>
  var wall;
  var profileURL;
  var fb;
  var frequency = 1000 * 60 * 7; // How frequently do we update? Every 7 minutes
  var mostRecentStream;
  var mostRecentWall;

  function getStreamPosts(update, cb) {
    if($('#fb').find('#content').length == 0 || update) {
      $('#fb').load('http://lite.facebook.com', null, function() {
        cb($('#fb'));
      });
    } else {
      cb($('#fb'));
    }
  }

  function getWallPosts(update, cb) {
    if($('#fb-wall').find('#content').length == 0 || update) {
      profileURL = 'http://lite.facebook.com' + $('#fb #header #navigation > a:nth-child(2)').attr('href');
      $('#fb-wall').load(profileURL, null, function() {
        cb($('#fb-wall'));
      });
    } else {
      cb($('#fb-wall'));
    }
  }

  function determineMostRecentStream() {
    if(mostRecentStream === undefined) {
      // determine mostRecentStream
      mostRecentStream = $('#fb #content #contentWrapper #home_stream li:first .actors .time').attr('href');
    } else {
      // determine newStream
      var newStream = $('#fb #content #contentWrapper #home_stream li:first .actors .time').attr('href');
      if(mostRecentStream != newStream) {
        mostRecentStream = newStream;
        chrome.browserAction.setBadgeText({text: "X" });
      }
    }
  }

  function determineMostRecentWall() {
    if(mostRecentWall === undefined) {
      mostRecentWall = $('#fb #content #contentWrapper .LSplitPage_Content .LSplitPage_Content:nth-child(2)  li:first .actors .time').attr('href');
    } else {
      var newWall = $('#fb #content #contentWrapper .LSplitPage_Content .LSplitPage_Content:nth-child(2)  li:first .actors .time').attr('href');
      // determine newWall
      if(mostRecentWall != newWall) {
        mostRecentWall = newWall;
        chrome.browserAction.setBadgeText({text: "X" });
      }
    }
  }

  function update() {
    getStreamPosts(true, function(a) { determineMostRecentStream(); getWallPosts(true, function(a) { determineMostRecentWall(); }); });
    window.setTimeout(update, frequency);
  }

  function getName() {
    return $('#fb-wall').find('#content #contentWrapper .LSplitPage_Content h1').contents().get(0).textContent;
  }

  $(document).ready(function() {
    update();
  });

</script>
</head>
<body>
  <div id="fb"></div>
  <div id="fb-wall"></div>
  <img id="logged_in" src="images/icon19.png" />
  <img id="logged_out" src="images/icon19_grey.png" />
</body>
</html>
