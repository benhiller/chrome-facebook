<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script>
      var fburl = "http://lite.facebook.com";

      function deserialize(params) {
        params = params.split('&');
        var dict = {}
        for(var i = 0; i < params.length; i++) {
          var param = params[i].split('=');
          dict[param[0]] = param[1];
        }
        return dict;
      }

      function postStatus(fb) {
        var status = $('#composer-area').val();
        $('#composer-area').val('What\'s on your mind?');
        var url = fburl + fb.find('#content .FN_publisher .LPublisherView .FN_write-view.profileWall .FN_write-form').attr('action');
        jQuery.post(url, {"source": "home", "message": status, "__async__": "true" });
      }

      function loadProfilePic(wall) {
        var src = wall.find('#content .profilePicture').attr('src');
        $('#pic').append('<img src="'+ src + '" width="40" height="40" title="Post a Status" />');
      }

      function fetchUrl(url, cb) {
        $('#fb-temp').load(url, null, function() {
          cb($('#fb-temp'));
        });
      }

      function processComment(div) {
        var comment = $('<li class="comment"></li>');
        var href = fburl + div.find('.p').attr('href');
        comment.append('<div class="comment-info"><a href="'+href+'" class="comment-name">'+div.find('.p').text()+'</a>' +
          '<span class="comment-time">'+div.find('.time').text()+'</span></div>');
        comment.append('<div class="comment-msg">'+div.find('p').text()+'</div>')
        return comment;
      }

      function processFeedback(f) {
        var feed = $('<div class="feedback"></div>');
        var likes = $('<div class="likes"></div>');
        var likeLink = f.find('.FN_does_not_like a:first').text();
        var likeHref = f.find('.FN_does_not_like a:first').attr('href');
        var likeText = f.find('.FN_does_not_like').text();

        if(likeLink != '') {
          likes.append('<a href="'+fburl+likeHref+'">'+likeLink+'</a>');
          likes.append(likeText.split(likeLink)[1]);
          feed.append(likes);
        }
        var comments = $('<ul class="comments"></ul>');
        f.find('.FN_all_comments .comment').map(function() {
          if($(this).hasClass('viewAll')) {
            var viewAll = $('<li class="comment view-all"></li>');
            var url = $(this).find('a').attr('href');
            viewAll.click(function() {
              fetchUrl(fburl + url, function(comments) {
                comments.find('#content #contentWrapper .story .FN_ufi_container .UFIView .FN_all_comments .comment').map(function() {
                  viewAll.before(processComment($(this)));
                });
                var current = viewAll;
                var next = viewAll.next();
                while(current.length != 0) {
                  current.replaceWith('');
                  current = next;
                  next = current.next();
                }
              });
            });
            viewAll.append('<div class="comment-msg"><span class="a">'+$(this).text()+'</span></div>');
            comments.append(viewAll);
            return 1;
          }
          if($(this).find('button').length != 0) {
            return 1;
          }
          var comment = processComment($(this));
          comments.append(comment);
          return 1;
        });
        feed.append(comments);
        return feed;
      }

      function showCommentBox() {
        if($(this).parent().parent().find('.feedback .comments .post-comment').length == 1) {
          $(this).parent().parent().find('.post-comment').toggle();
          return;
        } else {
          var link = fburl + $(this).parent().parent().parent().attr('id');
          var ul = $(this);
          fetchUrl(link, function(p) {
            var url = fburl + p.find('.FN_comment_form').attr('action');
            var params = deserialize(url.split('?')[1]);
            url = url.split('?')[0];
            var area = $('<li class="post-comment"><textarea cols="48" rows="3"></textarea><button class="comment-submit">Comment</button></li> ');
            area.find('.comment-submit').click(function() {
              var cmt = $(this).parent().find('textarea').val();
              var li = $('<li class="comment"></li>');
              var name = chrome.extension.getBackgroundPage().getName();
              var href = chrome.extension.getBackgroundPage().profileURL;
              li.append('<div class="comment-info"><a href="'+href+'" class="comment-name">'+name+'</a><span class="comment-time">Just now</span></div>');
              li.append('<div class="comment-msg">'+cmt+'</div>');
              ul.parent().parent().find('.post-comment').replaceWith(li);
              params['comment'] = cmt;
              params['__async__'] = 'true';
              jQuery.post(url, params);
            });
            ul.parent().parent().find('.feedback .comments').append(area);
          });
        }
      }

      function processMessageAndAttachment(li) {
          var msg = $('<div class="msg">'+li.find('.actors + p').text()+'</div>');
          var attch = li.find('.attachment');
          if(attch.length != 0) {
            var attchDiv = $('<div class="attch"></div>');
            attch.find('.attachmentMedia a').map(function() {
              if($(this).find('img').attr('src') !== undefined) {
                var attchItem;
                if($(this).attr('href').indexOf('http') == -1) {
                  attchItem = $('<a href="'+fburl + $(this).attr('href')+'"></a>');
                } else {
                  attchItem = $('<a href="'+ $(this).attr('href')+'"></a>');
                }
                var attchPic = $('<img src="'+$(this).find('img').attr('src')+'" />');
                attchItem.append(attchPic);
                attchDiv.append(attchItem);
              }
            });
            msg.append(attchDiv);
            var attchInfo = attch.find('div:nth-child(2)');
            if(attchInfo.html() != null) {
              var originalHref = attchInfo.find('a.title').attr('href');
              if(originalHref != undefined && originalHref.indexOf('http') == -1) {
                attchInfo.find('a.title').attr('href', fburl + originalHref);
              }
              msg.append('<div class="attch-info">'+attchInfo.html()+'</div>');
            }
          }
          return msg;
      }

      function processActors(li) {
        if(li.find('.actors .p').length == 1) {
          var name = li.find('.actors .p').text();
          var nameHref = fburl + li.find('.actors .p').attr('href');
          return [[name, nameHref]];
        } else {
          var n1 = li.find('.actors .p:first').text();
          var h1 = fburl + li.find('.actors .p:first').attr('href');
          var n2 = li.find('.actors .p:nth-child(3)').text();
          var h2 = fburl + li.find('.actors .p:nth-child(3)').attr('href');
          return [[n1, h1], [n2, h2]];
        }
      }

      function processActions(li, post, likeF, unlikeF) {
        var actions = $('<div class="actions"><span class="a comment-btn">Comment</span> &#183; <a class="like-btn">Like</a></div>');
        if(post.find('.msg .attch').length != 0) {
          actions.css('clear', 'both');
        }
        var f = li.find('.FN_ufi_container .meta');
        if(f.find('.FN_unlike').css('display') == 'none') {
          actions.find('.like-btn').toggle(likeF, unlikeF);
        } else {
          actions.find('.like-btn').toggle(unlikeF, likeF);
        }
        actions.find('.comment-btn').click(showCommentBox);
        return actions;
      }

      function handlePost(li) {
        if(li.hasClass('paginatorDummyStory')) {
          $('#loading').fadeOut();
          return null;
        } else if(li.hasClass('relationshipStory')) {
          var l = $('<li></li>');
          l.append('<div class="pic"><img class="mini" src="images/love.png" /></div>');
          var post = $('<div class="post"></div>');
          l.append(post);
          post.append(li.text().substring(1));
          return l;
        } else if(li.hasClass('wallPostStory')) {
          var l = $('<li></li>');
          l.append('<div class="pic"><img class="mini" src="images/comment.png" /></div>');
          var post = $('<div class="post"></div>');
          var contents = jQuery.makeArray(li.contents());
          var headline = '';
          for(var i = 1; i < contents.length; i++) {
            if(contents[i].className !== undefined && contents[i].className.indexOf('attachment') != -1) {
              break;
            }
            if(contents[i].pathname !== undefined) {
              headline = headline + '<a href="' + fburl + contents[i].pathname + '">'+contents[i].textContent+'</a>';
            } else {
              headline = headline + contents[i].textContent;
            }
          }
          post.append('<div class="info">'+headline+'</div>');
          var msg = processMessageAndAttachment(li);
          var feedback = processFeedback(li.find('.FN_ufi_container .UFIView'));
          var f = li.find('.FN_ufi_container .meta');
          var likeHref = fburl + f.find('.FN_like').attr('href');
          var unlikeHref = fburl + f.find('.FN_unlike').attr('href');
          var likeF = like(likeHref);
          var unlikeF = unlike(unlikeHref);
          post.append(msg);
          var actions = processActions(li, post, likeF, unlikeF);
          post.append(actions);
          post.append(feedback);
          l.append(post);
          return l;
        } else if(li.hasClass('videoStory')) {
          var name = li.find('a:first').text();
          var nameHref;
          if(name.length != 1) {
            nameHref = fburl + li.find('a:first').attr('href');
          } else {
            name = li.contents().get(2).textContent;
          }
          var desc = ' was tagged in a video.';
          var img = li.find('.attachment .attachmentMedia a');
          var l = $('<li></li>');
          l.append('<div class="pic"><img class="mini" src="images/video.png" /></div>');
          var post = $('<div class="post"></div>');
          if(nameHref != undefined) {
            post.append('<a class="name" href="'+nameHref+'">'+name+'</a>'+desc);
          } else {
            post.append(name);
          }
          post.append(processMessageAndAttachment(li));
          l.append(post);
          return l;

        } else if(li.hasClass('eventStory')) {
          var l = $('<li></li>');
          l.append('<div class="pic"><img class="mini" src="images/event.png" /></div>');
          var post = $('<div class="post"></div>');
          var filler = li.contents().get(2).textContent;
          var eventInfo = li.contents().get(3);
          post.append(filler);
          post.append('<a href="'+fburl+eventInfo.pathname+'" class="event-link">'+eventInfo.text+'</a>');
          l.append(post);
          return l;
        } else if(li.hasClass('photoStory')) {
          var name = li.find('a:first').text();
          var nameHref;
          if(name.length != 1) {
            nameHref = fburl + li.find('a:first').attr('href');
          } else {
            name = li.contents().get(2).textContent;
          }
          var desc;
          if(li.text().indexOf('photo') != -1) {
            desc = ' was tagged in a photo.';
          } else {
            desc = ' was tagged in an album.';
          }
          var img = li.find('.attachment .attachmentMedia a');
          var l = $('<li></li>');
          l.append('<div class="pic"><img class="mini" src="images/photo.png" /></div>');
          var post = $('<div class="post"></div>');
          if(nameHref != undefined) {
            post.append('<a class="name" href="'+nameHref+'">'+name+'</a>'+desc);
          } else {
            post.append(name);
          }
          post.append(processMessageAndAttachment(li));
          l.append(post);
          return l;
        } else {
          var picSrc = li.find('.profilePhoto img').attr('src');
          var time = li.find('.actors .time').text();
          var permalink = li.find('.actors .time').attr('href');
          var names = processActors(li);
          var msg = processMessageAndAttachment(li);
          var feedback = processFeedback(li.find('.FN_ufi_container .UFIView'));
          var f = li.find('.FN_ufi_container .meta');
          var likeHref = fburl + f.find('.FN_like').attr('href');
          var unlikeHref = fburl + f.find('.FN_unlike').attr('href');
          var likeF = like(likeHref);
          var unlikeF = unlike(unlikeHref);
          var l = $('<li></li>');
          l.append('<div class="pic"><img src="'+ picSrc +'" /></div>');
          var post = $('<div class="post"></div>');
          var info = $('<div class="info"></div>');
          for(var i = 0; i < names.length; i++) {
            info.append('<a href="'+names[i][1]+'" class="name">'+names[i][0]+'</a>');
            if(i != names.length - 1) {
              info.append(' &#155; ');
            }
          }
          info.append('<span class="time">'+time+'</span></div>');
          post.append(info);
          post.append(msg);
          var actions = processActions(li, post, likeF, unlikeF);
          post.append(actions);
          post.append(feedback);
          l.append(post);
          return l;
        }
      }

      function newWallPost(li) {
        var l = handlePost(li);
        if(l != null) {
          l.append('<div class="dummy"></div>');
          $('#wall').append(l);
        }
      }

      function newStreamPost(li) {
        var l = handlePost(li);
        if(l != null) {
          l.append('<div class="dummy"></div>');
          $('#stream').append(l);
        }
      }

      function like(url) {
        return function() {
          $(this).text('Unlike');
          jQuery.get(url);
        };
      }

      function unlike(url) {
        return function() {
          $(this).text('Like');
          jQuery.get(url);
        };
      }

      function renderStreamPosts(fb) {
        var loggedInCheck = fb.find('.container .headline').text();
        if(loggedInCheck != null && loggedInCheck.indexOf('The fastest way') == -1) {
          fb.find('#content #home_stream li').map(function() {
            newStreamPost($(this));
            return 1;
          });
          $('#stream').show();
        } else {
          $('#loading').hide();
          $('#error').show();
          $('#pic').hide();
        }
      }

      function renderWall(fb) {
        fb.find('#content #contentWrapper .LSplitPage_Content .LStreamView:nth-child(4) li').map(function() {
          newWallPost($(this));
          return 1;
        });
        $('#loading').hide();
      }

      function hideContents() {
        $('#stream, #wall, #inbox').hide();
      }

      $(document).ready(function() {
        chrome.extension.getBackgroundPage().markNotificationsRead();
        chrome.extension.getBackgroundPage().getStreamPosts(false, function(fb) {
          renderStreamPosts(fb);
          chrome.extension.getBackgroundPage().getWallPosts(false, function(fb) {
            loadProfilePic(fb);
            renderWall(fb);
          });
        });

        $('#items li').click(function() {
          if(!$(this).hasClass('selected'))  {
            $('#' + $('#items li.selected').attr('id').replace('-btn', '')).slideUp();
            $('#' + $(this).attr('id').replace('-btn', '')).slideDown();
            $('#items li.selected').removeClass('selected');
            $(this).addClass('selected');
          }
        });

        $('#pic').click(function() {
          if($('#composer').css('display') == 'none') {
            $("#composer").fadeIn();
          } else {
            $("#composer").fadeOut();
          }
        });

        $('#composer-area').focus(function() {
          $(this).val('');
        });

        $('#composer-submit').click(function() {
          chrome.extension.getBackgroundPage().getStreamPosts(false, postStatus);
          $("#composer").fadeOut();
        });

        $('#composer-cancel').click(function() {
          $("#composer").fadeOut();
          $('#composer-area').val('What\'s on your mind?');
        });

        $('a').live('click', function() {
          if($(this).attr('href') != '' && $(this).attr('href') != '#') {
            chrome.tabs.create({url: $(this).attr('href')});
          }
        });
      });
    </script>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div id="sidebar">
      <div id="pic">
      </div>
      <ul id="items">
        <li id="stream-btn" class=" selected"><img src="images/stream.png" title="Live Feed"/></li>
        <li id="wall-btn"><img src="images/incoming.png" title="Wall" /></li>
        <!-- <li id="inbox-btn"><img src="images/inbox.png" title="Inbox" /></li> -->
      </ul>
    </div>
    <div id="content">
      <div id="loading">
        <img src="images/loading.gif" />
      </div>
      <ul id="stream">
      </ul>
      <ul id="wall">
      </ul>
      <!-- <ul id="inbox">
        <li>
        TODO
        </li>
      </ul> -->
      <ul id="error">
        <p>To use the Facebook for Chrome extension, please login to <a href="http://facebook.com">Facebook</a> first.</p>
      </ul>
    </div>
    <div id="composer">
      <textarea rows="5" cols="49" id="composer-area">What's on your mind?</textarea>
      <button id="composer-submit">Share</button>
      <button id="composer-cancel">Cancel</button>
    </div>
    <div id="fb-temp"></div>
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
      var pageTracker = _gat._getTracker("UA-85731-3");
      pageTracker._setDomainName("none");
      pageTracker._setAllowLinker(true);
      pageTracker._trackPageview();
    } catch(err) {}</script>
  </body>
</html>
